<!--
File: chatbot.html (updated)
Authors: Hemasri Muddam
Contributors: Sindhu Priya Itukulapati
Updated by: Assistant (adds modality rendering)
Date: 2025-09-20
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NECHEcker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

  <style>
    :root {
      --unh-blue: #002B7D;
      --unh-white: #ffffff;
      --chat-bg: rgba(248, 249, 250, 0.95);
      --message-bg: rgba(233, 236, 239, 0.9);
      --input-bg: rgba(248, 249, 250, 0.95);
      --btn-color: #ebf0f9;
      --btn-hover: #0b5ed7;
      --btn-text: #ffffff;
      --border-radius: 0;
      --unh-black: #000000;
    }

    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    body {
      /* background-image: url("{{ url_for('static', filename='logo3.png') }}");  Background image, previously a bee*/
      background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed;
    }
    .page-container { height: 100vh; width: 100vw; backdrop-filter: blur(5px); background: rgba(0,0,0,.3); }
    .chat-container {
      height: 100vh; display: flex; flex-direction: column;
      background-color: rgba(255,255,255,.9); backdrop-filter: blur(10px);
      border-radius: 0; box-shadow: 0 0 20px rgba(0,0,0,.15); margin: 0;
    }
    .chat-header {
      background: linear-gradient(135deg, var(--unh-blue) 0%, #004db3 100%);
      color: var(--unh-white); padding: 1rem; display: flex; justify-content: center;
      border-bottom: 2px solid rgba(255,255,255,.1); height: 80px;
    }
    .header-content { display: flex; align-items: center; gap: 10px; }
    .chat-header-title { font-size: 24px; font-weight: 600; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,.1); }

    .chat-history {
      flex: 1; overflow-y: auto; padding: 2rem; display: flex; flex-direction: column; gap: 1rem; background-color: transparent;
    }

    .edit-icon-container {
      position: absolute; bottom: 40px; right: -2px; z-index: 1; display: flex; align-items: center; justify-content: center;
    }
    .edit-icon { font-size: 16px; color: var(--unh-black); cursor: pointer; transition: color .2s; }
    .edit-icon:hover { color: var(--unh-blue); }

    .message {
      position: relative; margin-bottom: 1.5rem; padding: 1rem; border-radius: 1rem; max-width: 75%;
      animation: fadeIn .3s ease-in-out; box-shadow: 0 3px 10px rgba(0,0,0,.1); word-wrap: break-word;
    }
    @keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: none;} }

    .user-message { background: rgba(255,255,255,.9); color: #212529; align-self: flex-end; border-bottom-right-radius: .25rem; text-align: left; }
    .assistant-message { background: rgba(255,255,255,.9); color: #212529; align-self: flex-start; border-bottom-left-radius: .25rem; backdrop-filter: blur(5px); text-align: left; }

    .message-avatar {
      width: 32px; height: 32px; position: absolute; bottom: -16px; border-radius: 50%;
      background: #fff; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,.1); z-index: 1;
    }
    .message-content { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .edit-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    .action-buttons { display: flex; gap: 8px; }
    .cancel-button, .send-button { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; line-height: 1.2; }
    .cancel-button { background: #f5f5f5; color: #333; }
    .send-button { background: #002B7D; color: #fff; }
    .send-button:hover { background: #001F5C; }
    .cancel-button:hover { background: #e0e0e0; }

    .user-message .message-avatar { right: -16px; background: var(--unh-blue); color: #fff; }
    .assistant-message .message-avatar { left: -16px; background: var(--unh-blue); color: #fff; }

    .input-area { display: flex; justify-content: center; align-items: center; padding: 15px; background: #e6e6fa; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; }
    .input-group { background: var(--unh-white); border-radius: 2rem; padding: .5rem; box-shadow: 0 2px 8px rgba(0,0,0,.1); margin-left: 20px; }
    #user-input { border: none; padding: .75rem 1.5rem; font-size: 1rem; background: transparent; }
    #user-input:focus { box-shadow: none; }

    .zip-symbol { display: none !important; }

    #send-button { width: 45px; height: 45px; border-radius: 50%; background: #0b5ed7; color: var(--btn-text); display: flex; align-items: center; justify-content: center; transition: all .3s; margin-right: .5rem; }
    #send-button:hover { background: #0b5ed7; transform: scale(1.05); }

    .plus-symbol i { color: #007bff; } .folder-symbol i { color: #28a745; }
    .plus-symbol i:hover { color: #0056b3; } .folder-symbol i:hover { color: #1e7e34; }

    .edit-button { position: absolute; top: .5rem; right: .5rem; background: rgba(255,255,255,.2); border: none; color: var(--unh-black);
      padding: .25rem .5rem; border-radius: .5rem; font-size: .8rem; cursor: pointer; transition: .2s; }
    .edit-button:hover { background: rgba(255,255,255,.3); }

    .chat-history::-webkit-scrollbar { width: 8px; }
    .chat-history::-webkit-scrollbar-track { background: rgba(0,0,0,.1); }
    .chat-history::-webkit-scrollbar-thumb { background: rgba(0,53,145,.5); border-radius: 4px; }
    .chat-history::-webkit-scrollbar-thumb:hover { background: rgba(0,53,145,.7); }

    .typing-indicator { display: flex; align-items: center; font-size: 1rem; color: #666; margin-top: 10px; }
    .typing-indicator .dot { width: 8px; height: 8px; background: #666; border-radius: 50%; margin: 0 2px; animation: blink 1s infinite alternate; }
    .typing-indicator .dot:nth-child(2){ animation-delay: .2s; } .typing-indicator .dot:nth-child(3){ animation-delay: .4s; }

    .status-pass { color: #28a745; font-weight: bold; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; }
    .status-fail { color: #dc3545; font-weight: bold; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; }

    .custom-blue-btn { background: #0043A4; color: #fff; border: none; }
    .custom-blue-btn:hover { background: #00327D; color: #fff; }

    @keyframes blink { 0% {opacity:0;} 100% {opacity:1;} }

    @media (max-width: 768px) {
      .chat-container { margin: 0; border-radius: 0; }
      .message { max-width: 85%; }
      .chat-header { padding: .75rem; height: 70px; }
      .chat-header-title { font-size: 1.2rem; }
      .chat-history { padding: 1rem; font-size: .9rem; }
      .input-area { flex-direction: column; padding: 10px; }
      .input-group { flex-direction: column; width: 100%; margin-left: 0; }
      #user-input { width: 100%; margin-top: .5rem; }
      #send-button { margin: 0 auto; margin-top: .5rem; }
    }
  </style>
</head>
<body>
  <!-- Hidden file inputs -->
  <input type="file" id="file-input" style="display:none"/>
  <input type="file" id="folder-input" style="display:none" multiple webkitdirectory/>
  <input type="file" id="zip-input" style="display:none" accept=".zip"/>

  <div class="page-container">
    <div class="container-fluid h-100 p-0">
      <div class="row h-100 m-0">
        <div class="col-12 p-0">
          <div class="chat-container">
            <div class="chat-header">
              <div class="header-content">
                <h1 class="chat-header-title">NECHEcker</h1>
              </div>
            </div>

            <div class="chat-history" id="chat-history"></div>

            <div class="input-area">
              <div class="input-group">
                <span class="input-group-text plus-symbol" id="plus-btn" style="cursor:pointer" title="Upload a file">
                  <i class="fas fa-paperclip"></i>
                </span>
                <span class="input-group-text folder-symbol" id="folder-btn" style="cursor:pointer" title="Upload a folder">
                  <i class="fas fa-folder-open"></i>
                </span>
                <span class="input-group-text zip-symbol" id="zip-btn" style="cursor:pointer" title="Upload a zip file">
                  <i class="fas fa-file-archive"></i>
                </span>
                <input type="text" id="user-input" class="form-control" placeholder="Type your text here..."/>
                <button id="send-button" class="btn">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>

            <input type="file" id="file-input-dup" style="display:none" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const chatHistory = document.getElementById('chat-history');
    const userInput   = document.getElementById('user-input');
    const sendButton  = document.getElementById('send-button');

    // File buttons
    document.getElementById('plus-btn').addEventListener('click', () => document.getElementById('file-input').click());
    document.getElementById('folder-btn').addEventListener('click', () => document.getElementById('folder-input').click());
    document.getElementById('folder-input').addEventListener('change', (e) => { if (e.target.files.length) uploadFolder(e.target.files); });
    document.getElementById('zip-btn').addEventListener('click', () => document.getElementById('zip-input').click());
    document.getElementById('zip-input').addEventListener('change', (e) => { if (e.target.files[0]) uploadZip(e.target.files[0]); });

    // Welcome
    window.addEventListener('load', () => {
      addHTMLMessage(`
        <strong>Welcome to NECHEcker!</strong><br>
        This tool now checks:
        <ul style="margin:8px 0 0 18px;">
          <li><strong>SLOs</strong> (regex-based headings & bullets)</li>
          <li><strong>Email</strong> </li>
          <li><strong>Instructor information</strong> </li>
          <li><strong>Office information</strong> </li>
          <li><strong>Workload information</strong> </li>
          <li><strong>Course Delivery</strong> — Online / Hybrid / In-Person (rule-based detector)</li>
        </ul>
        Upload a PDF or DOCX (or a ZIP/folder) to get results.
      `, false);
    });

    // Helpers to add messages
    function addHTMLMessage(html, isUser) {
      const msg = document.createElement('div');
      msg.classList.add('message', isUser ? 'user-message' : 'assistant-message');

      const content = document.createElement('div');
      content.classList.add('message-content');
      content.innerHTML = html;
      msg.appendChild(content);

      const avatar = document.createElement('div');
      avatar.classList.add('message-avatar');
      avatar.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
      msg.appendChild(avatar);

      if (isUser) addEditIcon(msg);


      chatHistory.appendChild(msg);
      chatHistory.scrollTop = chatHistory.scrollHeight;

      // Re-initialize Bootstrap tab logic for new tabs
      if (msg.querySelector('.detector-tabs')) {
        const tabTriggers = msg.querySelectorAll('[data-bs-toggle="tab"]');
        tabTriggers.forEach(trigger => {
          trigger.addEventListener('click', function (e) {
            e.preventDefault();
            const tabId = trigger.getAttribute('data-bs-target');
            const parent = trigger.closest('.detector-tabs');
            parent.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
            trigger.classList.add('active');
            parent.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show', 'active'));
            parent.querySelector(tabId).classList.add('show', 'active');
          });
        });
      }
    }

    function addMessage(text, isUser) {
      addHTMLMessage(text.replace(/\n/g,'<br>'), isUser);
    }

    function addEditIcon(messageDiv) {
      messageDiv.style.position = 'relative';
      const old = messageDiv.querySelector('.edit-icon-container'); if (old) old.remove();
      const cont = document.createElement('div'); cont.classList.add('edit-icon-container');
      const icon = document.createElement('div'); icon.classList.add('edit-icon'); icon.innerHTML = '<i class="fas fa-edit"></i>';
      icon.addEventListener('click', () => startEditing(messageDiv));
      cont.appendChild(icon);
      messageDiv.appendChild(cont);
    }

    // --- Typing indicator
    function addTypingIndicator() {
      const t = document.createElement('div'); t.classList.add('typing-indicator'); t.id = 'typing-indicator';
      t.innerHTML = 'Typing <div class="dot"></div><div class="dot"></div><div class="dot"></div>';
      chatHistory.appendChild(t); chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    function removeTypingIndicator() { const t = document.getElementById('typing-indicator'); if (t) t.remove(); }

    // --- Chat send
    sendButton.addEventListener('click', handleSend);
    userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });

    async function handleSend() {
      const message = userInput.value.trim();
      if (!message) return;
      addMessage(message, true);
      userInput.value = '';
      addTypingIndicator();
      try {
        const res = await fetch('/ask', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ message }) });
        removeTypingIndicator();
        if (res.ok) {
          const data = await res.json();
          addMessage(data.response || 'No response.', false);
        } else addMessage('Error: Unable to get a response.', false);
      } catch (e) {
        removeTypingIndicator();
        addMessage('Error: Unable to communicate with the server.', false);
      }
    }

    // ---------- DETECTION RENDERERS ----------
    // Normalize possible modality shapes from backend into a single object
    function normalizeModality(data) {
      // Preferred: rich 'modality' object
      if (data && data.modality) {
        const m = data.modality;
        return {
          status: m.status || (m.label ? 'PASS' : 'FAIL'),
          heading: m.heading || 'Detected delivery',
          label: m.label || m.course_delivery || 'Unknown',
          message: m.message || '',
          confidence: (typeof m.confidence === 'number') ? m.confidence : (m.confidence ? parseFloat(m.confidence) : null),
          details: (m.details || (Array.isArray(m.evidence) ? m.evidence.join('\n') : (m.evidence || ''))),
        };
      }
      // Fallback: flat fields
      if (data) {
        return {
          status: data.modality_status || (data.course_delivery ? 'PASS' : 'FAIL'),
          heading: 'Detected delivery',
          label: data.course_delivery || 'Unknown',
          message: data.course_delivery_message || '',
          confidence: (typeof data.course_delivery_confidence === 'number')
                      ? data.course_delivery_confidence
                      : (data.course_delivery_confidence ? parseFloat(data.course_delivery_confidence) : null),
          details: Array.isArray(data.course_delivery_evidence)
                    ? data.course_delivery_evidence.join('\n')
                    : (data.course_delivery_evidence || ''),
        };
      }
      return null;
    }

    function renderModalityCardFromData(data) {
      const m = normalizeModality(data);
      if (!m) return '';
      const status = m.status === 'PASS'
        ? '<span class="status-pass"><i class="fas fa-check-circle"></i> PASS</span>'
        : '<span class="status-fail"><i class="fas fa-times-circle"></i> FAIL</span>';

      const conf = (m.confidence || m.confidence === 0)
        ? `<div style="margin-top:4px;">Confidence: ${m.confidence}</div>` : '';

      const detailsPre = m.details
        ? `<pre style="white-space: pre-wrap; font-size:12px; margin-top:6px;">${m.details}</pre>` : '';

      const labelLine = m.label ? `<div><strong>Label:</strong> ${m.label}</div>` : '';

      return `
        <div class="upload-result" style="margin-top: 12px;">
          <h4><i class="fas fa-chalkboard-teacher"></i> Course Delivery</h4>
          <div class="analysis-summary">
            <div class="status-item"><strong>Result:</strong> ${status}</div>
            <div class="message">
              <strong>${m.heading}</strong><br>
              ${m.message || ''}
            </div>
            ${labelLine}
            ${conf}
            ${detailsPre}
          </div>
        </div>
      `;
    }

    function renderInstructorCard(data) {
      const name = data.name;
      const title = data.title;
      const department = data.department;
      const confidence = typeof data.confidence === 'number' ? data.confidence : null;
      let html = '<div class="upload-result" style="margin-top: 12px;">';
      html += '<h4><i class="fas fa-user"></i> Instructor Information</h4>';
      if (!name && !title && !department || name === 'N/A' || title === 'N/A' || department === 'N/A') {
        html += '<div class="analysis-summary"><strong>Not found</strong></div>';
      } else {
        html += '<div class="analysis-summary">';
        if (name) html += `<div><strong>Name:</strong> ${name}</div>`;
        if (title) html += `<div><strong>Title:</strong> ${title}</div>`;
        if (department) html += `<div><strong>Department:</strong> ${department}</div>`;
        if (confidence !== null) html += `<div><strong>Confidence:</strong> ${confidence}</div>`;
        html += '</div>';
      }
      html += '</div>';
      return html;
    }

    // Existing SLO block (kept) + Modality block (new)
    function displayDetections(data) {
        // Overview tab: summarize pass/fail for each detector
        function getStatus(val, passText = 'PASS', failText = 'FAIL') {
          return val ? `<span class="status-pass"><i class="fas fa-check-circle"></i> ${passText}</span>` : `<span class="status-fail"><i class="fas fa-times-circle"></i> ${failText}</span>`;
        }

        const overviewHTML = `
          <div class="upload-result" style="margin-top: 12px;">
            <h3><i class="fas fa-list"></i> Overview</h3>
            <div class="analysis-summary">
              <div><strong>SLOs:</strong> ${getStatus(data.slo_status === 'PASS')}</div>
              <div><strong>Instructor:</strong> ${getStatus(data.instructor && data.instructor.found)}</div>
              <div><strong>Modality:</strong> ${getStatus(data.modality_status === 'PASS')}</div>
              <div><strong>Office:</strong> ${getStatus(data.office_information && data.office_information.found)}</div>
              <div><strong>Email:</strong> ${getStatus(data.email_information && data.email_information.found)}</div>
              <div><strong>Credit Hours:</strong> ${getStatus(data.credit_hours && data.credit_hours.found)}</div>
              <div><strong>Workload:</strong> ${getStatus(data.workload_information && data.workload_information.found)}</div>
            </div>
          </div>
        `;
      const status = data.slo_status === 'PASS'
        ? '<span class="status-pass"><i class="fas fa-check-circle"></i> PASS</span>'
        : '<span class="status-fail"><i class="fas fa-times-circle"></i> FAIL</span>';

      const sloPreview = data.slo_content
        ? `<div style="margin-top:10px; padding:10px; background:#f5f5f5; border-radius:5px;">
             <strong>SLO Content Found:</strong><br>
             <pre style="white-space: pre-wrap; font-size:12px;">${data.slo_content}</pre>
           </div>` : '';

      const messageLabel = data.slo_status === 'PASS' ? 'Result:' : 'Missing Fields:';

      const sloHTML = `
        <div class="upload-result">
          <h3><i class="fas fa-file-pdf"></i> ${data.filename || 'Uploaded Document'}</h3>
          <div class="analysis-summary">
            <div class="status-item"><strong>Student Learning Outcomes:</strong> ${status}</div>
            <div class="message"><strong>${messageLabel}</strong> ${data.message || ''}</div>
            ${sloPreview}
          </div>
        </div>
      `;


        // Instructor info box
        const instructor = data.instructor || {};
        const instructorFound = instructor.found ? '<span class="status-pass"><i class="fas fa-check-circle"></i> FOUND</span>' : '<span class="status-fail"><i class="fas fa-times-circle"></i> NOT FOUND</span>';
        const instructorHTML = `
          <div class="upload-result">
            <h3><i class="fas fa-user-tie"></i> ${data.filename || 'Uploaded Document'}</h3>
            <div class="analysis-summary">
              <div class="status-item"><strong>Instructor Info:</strong> ${instructorFound}</div>
              <div class="message">
                <strong>Name:</strong> ${instructor.name || 'N/A'}<br>
                <strong>Title:</strong> ${instructor.title || 'N/A'}<br>
                <strong>Department:</strong> ${instructor.department || 'N/A'}
              </div>
            </div>
          </div>
        `;

      const modalityHTML = renderModalityCardFromData(data);

        // Office Information

          const office = data.office_information || {};
          const officeFound = office.location || office.hours || office.phone;
          const officeStatus = officeFound ? '<span class="status-pass"><i class="fas fa-check-circle"></i> FOUND</span>' : '<span class="status-fail"><i class="fas fa-times-circle"></i> NOT FOUND</span>';
          const officePreview = officeFound ? `<div style="margin-top:10px; padding:10px; background:#f5f5f5; border-radius:5px;"><strong>Office Details:</strong><br><pre style="white-space: pre-wrap; font-size:12px;">Location: ${office.location || 'N/A'}\nHours: ${office.hours || 'N/A'}\nPhone: ${office.phone || 'N/A'}</pre></div>` : '';
          const officeHTML = `
            <div class="upload-result">
              <h3><i class="fas fa-building"></i> ${data.filename || 'Uploaded Document'}</h3>
              <div class="analysis-summary">
                <div class="status-item"><strong>Office Information:</strong> ${officeStatus}</div>
                ${officePreview}
              </div>
            </div>
          `;

        // Email

          const email = data.email_information || {};
          const emailStatus = email.found ? '<span class="status-pass"><i class="fas fa-check-circle"></i> FOUND</span>' : '<span class="status-fail"><i class="fas fa-times-circle"></i> NOT FOUND</span>';
          const emailPreview = email.email ? `<div style="margin-top:10px; padding:10px; background:#f5f5f5; border-radius:5px;"><strong>Email:</strong> <pre style="white-space: pre-wrap; font-size:12px;">${email.email}</pre></div>` : '';
          const emailHTML = `
            <div class="upload-result">
              <h3><i class="fas fa-envelope"></i> ${data.filename || 'Uploaded Document'}</h3>
              <div class="analysis-summary">
                <div class="status-item"><strong>Email Information:</strong> ${emailStatus}</div>
                ${emailPreview}
              </div>
            </div>
          `;

        // Credit Hours

          const credit = data.credit_hours || {};
          const creditStatus = credit.found ? '<span class="status-pass"><i class="fas fa-check-circle"></i> FOUND</span>' : '<span class="status-fail"><i class="fas fa-times-circle"></i> NOT FOUND</span>';
          const creditPreview = credit.hours ? `<div style="margin-top:10px; padding:10px; background:#f5f5f5; border-radius:5px;"><strong>Credit Hours:</strong> <pre style="white-space: pre-wrap; font-size:12px;">${credit.hours}</pre></div>` : '';
          const creditHTML = `
            <div class="upload-result">
              <h3><i class="fas fa-clock"></i> ${data.filename || 'Uploaded Document'}</h3>
              <div class="analysis-summary">
                <div class="status-item"><strong>Credit Hours:</strong> ${creditStatus}</div>
                ${creditPreview}
              </div>
            </div>
          `;

        // Workload

          const workload = data.workload_information || {};
          const workloadStatus = workload.found ? '<span class="status-pass"><i class="fas fa-check-circle"></i> FOUND</span>' : '<span class="status-fail"><i class="fas fa-times-circle"></i> NOT FOUND</span>';
          const workloadPreview = workload.description ? `<div style="margin-top:10px; padding:10px; background:#f5f5f5; border-radius:5px;"><strong>Workload Description:</strong> <pre style="white-space: pre-wrap; font-size:12px;">${workload.description}</pre></div>` : '';
          const workloadHTML = `
            <div class="upload-result">
              <h3><i class="fas fa-tasks"></i> ${data.filename || 'Uploaded Document'}</h3>
              <div class="analysis-summary">
                <div class="status-item"><strong>Workload Information:</strong> ${workloadStatus}</div>
                ${workloadPreview}
              </div>
            </div>
          `;


        // Tab system for detector outputs
        const tabNames = [
          { id: 'overview', label: 'Overview', icon: 'fa-list', html: overviewHTML },
          { id: 'slo', label: 'SLOs', icon: 'fa-file-pdf', html: sloHTML },
          { id: 'instructor', label: 'Instructor', icon: 'fa-user-tie', html: instructorHTML },
          { id: 'modality', label: 'Modality', icon: 'fa-chalkboard-teacher', html: modalityHTML },
          { id: 'office', label: 'Office', icon: 'fa-building', html: officeHTML },
          { id: 'email', label: 'Email', icon: 'fa-envelope', html: emailHTML },
          { id: 'credit', label: 'Credit Hours', icon: 'fa-clock', html: creditHTML },
          { id: 'workload', label: 'Workload', icon: 'fa-tasks', html: workloadHTML }
        ];

        let tabs = '<div class="detector-tabs"><ul class="nav nav-tabs" role="tablist">';
        tabNames.forEach((tab, idx) => {
          tabs += `<li class="nav-item" role="presentation">
            <button class="nav-link${idx === 0 ? ' active' : ''}" id="${tab.id}-tab" data-bs-toggle="tab" data-bs-target="#${tab.id}-panel" type="button" role="tab" aria-controls="${tab.id}-panel" aria-selected="${idx === 0 ? 'true' : 'false'}">
              <i class="fas ${tab.icon}"></i> ${tab.label}
            </button>
          </li>`;
        });
        tabs += '</ul>';

        tabs += '<div class="tab-content" style="margin-top:10px;">';
        tabNames.forEach((tab, idx) => {
          tabs += `<div class="tab-pane fade${idx === 0 ? ' show active' : ''}" id="${tab.id}-panel" role="tabpanel" aria-labelledby="${tab.id}-tab">${tab.html}</div>`;
        });
        tabs += '</div></div>';

        addHTMLMessage(tabs, false);
      }

    // ---------- Upload handlers ----------
    function displaySelectedFile(file){ addMessage(`Selected document: ${file.name}`, true); }

    document.getElementById('file-input').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      displaySelectedFile(file);
      const ext = file.name.split('.').pop().toLowerCase();
      if (ext === 'zip') uploadZip(file);
      else if (ext === 'pdf' || ext === 'docx') uploadPDF(file);
      else addMessage('Unsupported file type. Please upload a PDF, DOCX, or ZIP file.', false);
    });

    async function uploadZip(zipFile) {
      const formData = new FormData(); formData.append('file', zipFile);
      const msg = document.createElement('div'); msg.classList.add('message','assistant-message');
      msg.innerHTML = `<div class="message-content">Uploading ZIP file: <strong>${zipFile.name}</strong>...</div>`;
      chatHistory.appendChild(msg); chatHistory.scrollTop = chatHistory.scrollHeight;

      try {
        const response = await fetch('/upload', { method:'POST', body: formData });
        const data = await response.json();
        if (!response.ok) { addMessage(`Error: ${data.error || 'Failed to process ZIP.'}`, false); return; }

        msg.querySelector('.message-content').innerHTML = `✅ Uploaded ZIP file: <strong>${zipFile.name}</strong>`;

        const list = data.results || data.extracted_information || [];
        addMessage(`Processed ${list.length} files.`, false);

        // New simplified format => each item is one detection payload with slo & modality
        if (Array.isArray(list) && list.length && ('slo_status' in list[0] || 'modality' in list[0] || 'course_delivery' in list[0])) {
          list.forEach(displayDetections);
          return;
        }

        // Legacy (kept for backward compatibility) — you can remove if not needed
        addMessage('Legacy ZIP format detected; please update backend to new detector response.', false);

      } catch (err) {
        console.error(err); addMessage('Failed to upload ZIP file. Please try again.', false);
      }
    }

    async function uploadFolder(files) {
      const formData = new FormData();
      for (const f of files) formData.append('files', f);

      const msg = document.createElement('div'); msg.classList.add('message','assistant-message');
      msg.innerHTML = `<div class="message-content">Uploading folder: <strong>${files.length}</strong> files...</div>`;
      chatHistory.appendChild(msg); chatHistory.scrollTop = chatHistory.scrollHeight;

      try {
        const response = await fetch('/upload', { method:'POST', body: formData });
        const data = await response.json();
        if (!response.ok) { addMessage(`Error: ${data.error || 'Folder upload failed.'}`, false); return; }

        msg.querySelector('.message-content').innerHTML = `✅ Uploaded folder: <strong>${files.length}</strong> files`;

        const list = data.results || data.extracted_information || [];
        addMessage(`Processed ${list.length} files.`, false);

        if (Array.isArray(list) && list.length && ('slo_status' in list[0] || 'modality' in list[0] || 'course_delivery' in list[0])) {
          list.forEach(displayDetections);
          return;
        }

        addMessage('Legacy folder format detected; please update backend to new detector response.', false);

      } catch (err) {
        console.error(err); addMessage('Failed to upload folder. Please try again.', false);
      }
    }

    async function uploadPDF(file) {
      const allowed = ['pdf','docx','zip']; const ext = file.name.split('.').pop().toLowerCase();
      if (!allowed.includes(ext)) { addMessage('Unsupported file type. Please upload a PDF, DOCX, or ZIP file.', false); return; }

      const formData = new FormData(); formData.append('file', file);

      const msg = document.createElement('div'); msg.classList.add('message','assistant-message');
      msg.innerHTML = `<div class="message-content">Uploading file: <strong>${file.name}</strong>...</div>`;
      chatHistory.appendChild(msg); chatHistory.scrollTop = chatHistory.scrollHeight;

      try {
        const response = await fetch('/upload', { method:'POST', body: formData });
        const data = await response.json();

        if (!response.ok) { addMessage(`Error: ${data.error || 'Upload failed.'}`, false); return; }

        // New simplified format (SLO + Modality)
        if (data.slo_status || data.modality || data.course_delivery) {
          data.filename = data.filename || file.name; // ensure name
          displayDetections(data);
          msg.querySelector('.message-content').innerHTML = `✅ Uploaded file: <strong>${file.name}</strong>`;
          addMessage('You can upload more files for analysis.', false);
          return;
        }

        // Legacy path (kept if you still return extracted_information tables)
        addMessage('Legacy single-file format detected; please update backend to new detector response.', false);
        msg.querySelector('.message-content').innerHTML = `✅ Uploaded file: <strong>${file.name}</strong>`;

      } catch (err) {
        console.error(err); addMessage('Failed to upload file. Please try again.', false);
      }
    }

    // ------------- Editing (kept from your original) -------------
    let editingMessageElement = null;

    function startEditing(messageElement) {
      if (!messageElement) return;
      if (editingMessageElement && editingMessageElement !== messageElement) cancelEditing();
      editingMessageElement = messageElement;

      const contentSpan = messageElement.querySelector('.message-content span');
      if (!contentSpan) return;
      const original = contentSpan.textContent;
      if (!messageElement.hasAttribute('data-original-content')) {
        messageElement.setAttribute('data-original-content', original);
      }

      const editDiv = document.createElement('div');
      editDiv.contentEditable = true;
      editDiv.textContent = original;
      editDiv.classList.add('form-control', 'edit-input');
      editDiv.style.display = 'inline-block'; editDiv.style.minWidth = '50px'; editDiv.style.maxWidth = '100%';
      editDiv.style.whiteSpace = 'pre-wrap'; editDiv.style.wordBreak = 'break-word'; editDiv.style.border = '1px solid #ccc'; editDiv.style.padding = '5px';

      function adjustHeight(){ editDiv.style.height='auto'; editDiv.style.height = editDiv.scrollHeight + 'px'; }
      editDiv.addEventListener('input', adjustHeight);

      const actions = document.createElement('div'); actions.classList.add('action-buttons');
      const cancelBtn = document.createElement('button'); cancelBtn.textContent = 'Cancel'; cancelBtn.classList.add('cancel-button'); cancelBtn.addEventListener('click', cancelEditing);
      const sendBtn = document.createElement('button'); sendBtn.textContent = 'Send'; sendBtn.classList.add('send-button'); sendBtn.addEventListener('click', () => saveEditing(messageElement, editDiv.textContent));
      actions.appendChild(cancelBtn); actions.appendChild(sendBtn);

      const container = messageElement.querySelector('.message-content');
      container.innerHTML = ''; container.appendChild(editDiv); container.appendChild(actions);
      editDiv.focus(); moveCaretToEnd(editDiv); adjustHeight();
    }

    function moveCaretToEnd(el){ const r=document.createRange(), s=window.getSelection(); r.selectNodeContents(el); r.collapse(false); s.removeAllRanges(); s.addRange(r); }

    function saveEditing(messageElement, newContent) {
      if (!messageElement || !newContent.trim()) { cancelEditing(); return; }
      const mc = messageElement.querySelector('.message-content');
      const span = document.createElement('span'); span.textContent = newContent.trim();
      mc.innerHTML = ''; mc.appendChild(span);
      addEditIcon(messageElement);

      const all = Array.from(chatHistory.querySelectorAll('.message'));
      let after = false;
      for (const m of all) {
        if (m === messageElement) after = true;
        else if (after) m.remove();
      }
      editingMessageElement = null;
      handleResend(newContent.trim());
    }

    function cancelEditing() {
      if (!editingMessageElement) return;
      const original = editingMessageElement.getAttribute('data-original-content');
      const mc = editingMessageElement.querySelector('.message-content');
      const span = document.createElement('span'); span.textContent = original;
      addEditIcon(editingMessageElement);
      mc.innerHTML=''; mc.appendChild(span);
      editingMessageElement.removeAttribute('data-original-content');
      editingMessageElement = null;
    }

    async function handleResend(editedMessage) {
      try {
        addTypingIndicator();
        const response = await fetch('/ask', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message: editedMessage }) });
        removeTypingIndicator();
        if (response.ok) {
          const data = await response.json();
          addMessage(data.response, false);
        } else addMessage('Error: Unable to get a response.', false);
      } catch (e) {
        removeTypingIndicator(); addMessage('Error: Unable to communicate with the server.', false);
      }
    }

    // ------------- Report viewer, email, download (kept) -------------
    let currentReportFilename = '';
    function viewReport(reportId, filename) {
      // (kept from your original — unchanged)
      alert('Legacy report view path. New detector flow renders results in chat.'); // minimal placeholder
    }

    function isValidUNHEmail(email){ return typeof email === 'string' && email.toLowerCase().endsWith('@unh.edu'); }

    async function shareReportByEmail() {
      // unchanged (you can wire this to new rendered blocks if needed)
      alert('Share via Email: use backend /email_report with HTML you want to send.');
    }

    function downloadReportFromModal() {
      alert('Download PDF: hook html2pdf to the DOM you want to export.');
    }
  </script>

  <!-- Modal shell left intact (legacy flow) -->
  <div class="modal fade" id="viewReportModal" tabindex="-1" aria-labelledby="viewReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewReportModalLabel">NECHE Compliance Report Viewer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="reportContent"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="downloadReportFromModal()">Download PDF</button>
        <button type="button" class="btn btn-success" onclick="shareReportByEmail()">Share via Email</button>
      </div>
    </div></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</body>
</html>
